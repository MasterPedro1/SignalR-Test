<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pedidos - Vendedores</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/7.0.5/signalr.min.js"></script>
</head>
<body class="bg-gray-100 text-gray-900">

    <div class="max-w-4xl mx-auto py-10">
        <h2 class="text-3xl font-bold text-center mb-6">Registro de Pedidos</h2>

        <!-- Ingreso de nombre -->
        <div class="bg-white p-6 rounded-lg shadow-md mb-6 text-center">
            <input type="text" id="nombreVendedor" placeholder="Ingresa tu nombre" class="border rounded px-4 py-2 w-64">
            <button onclick="guardarNombre()" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">
                Aceptar
            </button>
        </div>

        <!-- Tabla de pedidos -->
        <div class="bg-white p-6 rounded-lg shadow-md">
            <table class="w-full border-collapse">
                <thead>
                    <tr class="bg-gray-200">
                        <th class="p-3 text-left">Pedido</th>
                        <th class="p-3 text-left">Cantidad</th>
                        <th class="p-3 text-left">Fecha</th>
                        <th class="p-3 text-left">Usuario</th>
                        <th class="p-3 text-left">Estatus</th>
                        <th class="p-3 text-center">Acciones</th>
                    </tr>
                </thead>
                <tbody id="tablaPedidos"></tbody>
            </table>
        </div>

        <!-- Formulario para agregar pedido -->
        <div class="mt-6 bg-white p-6 rounded-lg shadow-md">
            <h3 class="text-xl font-semibold mb-4">Agregar Pedido</h3>
            <input type="text" id="pedido" placeholder="Pedido" class="border rounded px-4 py-2 w-64 mr-2">
            <input type="text" id="cantidad" placeholder="Cantidad" class="border rounded px-4 py-2 w-24">
            <button onclick="agregarPedido()" class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600">
                Enviar Pedido
            </button>
        </div>
    </div>

    <script>
        const connection = new signalR.HubConnectionBuilder()
            .withUrl("/pedidoHub")
            .build();

        let usuario = "";

        connection.start().then(() => {
            console.log("Conectado a SignalR");
            connection.invoke("ObtenerPedidos");
        });

        function guardarNombre() {
            usuario = document.getElementById("nombreVendedor").value;
        }

        function agregarPedido() {
            const pedido = document.getElementById("pedido").value;
            const cantidad = document.getElementById("cantidad").value;
            const fecha = new Date().toISOString().split('T')[0];

            if (!pedido || !cantidad || !usuario) {
                alert("Todos los campos son obligatorios");
                return;
            }

            const nuevoPedido = { pedido, cantidad, fecha, usuario, estatus: "Pendiente" };
            connection.invoke("EnviarPedido", nuevoPedido);
        }

        connection.on("RecibirPedido", (pedido) => {
            actualizarTabla(pedido);
        });

        function actualizarTabla(pedido) {
            const tabla = document.getElementById("tablaPedidos");
            const fila = document.createElement("tr");
            fila.classList.add("border-b");
            fila.innerHTML = `
                        <td class="p-3">${pedido.pedido}</td>
                        <td class="p-3">${pedido.cantidad}</td>
                        <td class="p-3">${pedido.fecha}</td>
                        <td class="p-3">${pedido.usuario}</td>
                        <td class="p-3 text-yellow-500">${pedido.estatus}</td>
                        <td class="p-3 text-center">
                            ${pedido.usuario === usuario ? `<button onclick="eliminarPedido('${pedido.id}')" class="bg-red-500 text-white px-2 py-1 rounded hover:bg-red-600">Eliminar</button>` : ""}
                        </td>
                    `;
            tabla.appendChild(fila);
        }

        function eliminarPedido(idPedido) {
            connection.invoke("EliminarPedido", usuario, idPedido);
        }

        connection.on("PedidoEliminado", (idPedido) => {
            document.getElementById("tablaPedidos").querySelectorAll("tr").forEach(row => {
                if (row.dataset.id === idPedido) row.remove();
            });
        });
    </script>

</body>
</html>
