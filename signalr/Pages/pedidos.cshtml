@page


<html lang="es">

<head>

    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Pedidos - Ventas y Modelos</title>

    <!-- Bootstrap 4 CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" />
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" />
    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <!-- Popper.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.16.0/umd/popper.min.js"></script>
    <!-- Bootstrap 4 JS -->
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>

    <style>
        body {
            background-color: #f8f9fa;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .card {
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            border: none;
        }

        .card-header {
            border-radius: 10px 10px 0 0 !important;
        }

        .nav-tabs {
            border-bottom: 2px solid #dee2e6;
        }

            .nav-tabs .nav-link {
                font-weight: 500;
                border: none;
                color: #6c757d;
                padding: 0.75rem 1.5rem;
            }

                .nav-tabs .nav-link.active {
                    color: #007bff;
                    background-color: transparent;
                    border-bottom: 3px solid #007bff;
                    font-weight: 600;
                }

        .table-responsive {
            overflow-x: auto;
        }

        .table-sm {
            font-size: 0.8rem;
        }

            .table-sm td, .table-sm th {
                padding: 0.3rem;
                vertical-align: middle;
            }

        .table thead th {
            border-bottom-width: 1px;
            font-weight: 600;
            white-space: nowrap;
            width: 1%;
            background-color: #343a40; /* Fondo oscuro para el encabezado */
            color: white; /* Texto blanco para contraste */
        }

        .btn-header {
            font-size: 0.6rem;
            padding: 0.1rem 0.3rem;
            margin-left: 0.15rem;
        }

        .dropdown-toggle::after {
            margin-left: 0.5em;
        }

        /* Modales */
        .modal-dialog.modal-lg {
            max-width: 1200px;
            margin: 1.75rem auto;
        }

        .modal-content {
            border-radius: 12px;
            border: 1px solid #dee2e6;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            overflow: hidden;
        }

        .modal-header {
            background-color: #f8f9fa;
            border-bottom: 1px solid #dee2e6;
            padding: 1rem 1.5rem;
            border-top-left-radius: 12px;
            border-top-right-radius: 12px;
        }

        .modal-title {
            font-weight: 600;
            font-size: 1.1rem;
            color: #343a40;
        }

        .modal-body {
            padding: 1rem;
            max-height: 70vh;
            overflow-y: auto;
        }

        .modal-footer {
            border-top: 1px solid #dee2e6;
            padding: 0.75rem 1.5rem;
            background-color: #f8f9fa;
            border-bottom-left-radius: 12px;
            border-bottom-right-radius: 12px;
        }

        /* Tablas dentro de modales */
        .modal-table-container {
            padding: 0.5rem;
            background-color: #fff;
            border-radius: 8px;
            border: 1px solid #e9ecef;
        }

        .table-detail {
            margin-bottom: 0;
            width: 100%;
            font-size: 0.75rem;
            border-collapse: separate;
            border-spacing: 0;
        }

            .table-detail th {
                background-color: #f1f3f5;
                position: sticky;
                top: 0;
                padding: 0.5rem;
                border-bottom: 2px solid #dee2e6;
            }

            .table-detail td {
                white-space: nowrap;
                padding: 0.4rem;
                border-top: 1px solid #e9ecef;
            }

            .table-detail tr:hover td {
                background-color: #f8f9fa;
            }

            .table-detail th,
            .table-detail td {
                white-space: normal;
                word-break: break-word;
                max-width: 180px;
            }

        /* Paginación */
        .pagination-container {
            display: flex;
            justify-content: center;
            padding: 1rem;
            border-top: 1px solid #dee2e6;
            background-color: white;
            margin-top: 1rem;
            border-radius: 0 0 8px 8px;
        }

        .page-item.active .page-link {
            background-color: #007bff;
            border-color: #007bff;
        }

        .page-link {
            color: #007bff;
            padding: 0.25rem 0.5rem;
            font-size: 0.8rem;
            border-radius: 4px;
        }

        /* Scrollbar personalizado */
        .modal-body::-webkit-scrollbar {
            width: 8px;
        }

        .modal-body::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }

        .modal-body::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 10px;
        }

            .modal-body::-webkit-scrollbar-thumb:hover {
                background: #a8a8a8;
            }

        /* Estilos específicos para esta página */
        .dropdown-toggle.text-right::after {
            margin-left: 0.5em;
        }

        .dropdown-menu {
            max-height: 300px;
            overflow-y: auto;
        }

        .btn-outline-secondary {
            border-color: #ced4da;
        }

        /* =========================================
                       EVITAR SCROLL HORIZONTAL EN "Modelos y Versiones"
                       Forzamos salto de línea en #modelosTable thead th
                       ========================================= */
        #modelosTable thead th {
            white-space: normal !important; /* Permite múltiples líneas */
            word-break: break-word !important; /* Rompe palabras largas */
            width: auto !important; /* Anula width: 1%; */
            max-width: 120px !important; /* Ajusta según tu preferencia */
        }

        /* =========================================
                       ESTILOS PARA FILAS DE TOTALES Y PORCENTAJES
                       ========================================= */
        .table-info td {
            background-color: #e7f5ff !important;
            font-weight: 600;
        }

        .table-light td {
            background-color: #f8f9fa !important;
            font-style: italic;
        }
    </style>

</head>

<body>
    <div class="container py-4">
        <div class="card mb-4">
            <div class="card-header bg-primary text-white">
                <h2 class="h5 mb-0 text-center"><i class="fas fa-clipboard-list mr-2"></i>Pedidos</h2>
            </div>
            <div class="card-body">
                <!-- Nav Tabs -->
                <ul class="nav nav-tabs mb-4" id="myTab" role="tablist">
                    <li class="nav-item">
                        <a class="nav-link active" id="tab1-tab" data-toggle="tab" href="#tab1" role="tab">
                            <i class="fas fa-car mr-1"></i> Ventas de Coches
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" id="tab2-tab" data-toggle="tab" href="#tab2" role="tab">
                            <i class="fas fa-list-alt mr-1"></i> Modelos y Versiones
                        </a>
                    </li>
                </ul>

                <div class="tab-content" id="myTabContent">
                    <!-- PESTAÑA 1: Ventas de Coches -->
                    <div class="tab-pane fade show active" id="tab1" role="tabpanel">
                        <!-- Filtros -->
                        <div class="row mb-3">
                            <div class="col-md-4 mb-2">
                                <div class="dropdown">
                                    <button class="btn btn-outline-secondary dropdown-toggle w-100 text-left d-flex justify-content-between align-items-center" type="button" id="marcaDropdown" data-toggle="dropdown">
                                        <span><i class="fas fa-tag mr-2"></i>Selecciona Marca</span>
                                    </button>
                                    <div class="dropdown-menu w-100" id="marcaDropdownMenu"></div>
                                </div>
                            </div>
                            <div class="col-md-4 mb-2">
                                <div class="dropdown">
                                    <button class="btn btn-outline-secondary dropdown-toggle w-100 text-left d-flex justify-content-between align-items-center" type="button" id="sucursalDropdown" data-toggle="dropdown">
                                        <span><i class="fas fa-store mr-2"></i>Selecciona Sucursal</span>
                                    </button>
                                    <div class="dropdown-menu w-100" id="sucursalDropdownMenu"></div>
                                </div>
                            </div>
                            <div class="col-md-4 mb-2">
                                <div class="input-group">
                                    <div class="input-group-prepend">
                                        <span class="input-group-text"><i class="fas fa-calendar-alt"></i></span>
                                    </div>
                                    <input type="date" class="form-control" id="fechaFiltro" />
                                </div>
                            </div>
                        </div>

                        <!-- Tabla Principal -->
                        <div class="table-responsive">
                            <table class="table table-sm table-bordered table-hover" id="ventasTable">
                                <thead class="thead-light">
                                    <tr id="tableHeader"></tr>
                                </thead>
                                <tbody id="tableBody"></tbody>
                            </table>
                        </div>
                    </div>

                    <!-- PESTAÑA 2: Modelos y Versiones -->
                    <div class="tab-pane fade" id="tab2" role="tabpanel">
                        <!-- Filtros -->
                        <div class="row mb-3">
                            <div class="col-md-6 mb-2">
                                <div class="dropdown">
                                    <button class="btn btn-outline-secondary dropdown-toggle w-100 text-left d-flex justify-content-between align-items-center" type="button" id="modeloDropdown" data-toggle="dropdown">
                                        <span><i class="fas fa-car mr-2"></i>Selecciona Modelo</span>
                                    </button>
                                    <div class="dropdown-menu w-100" id="modeloDropdownMenu"></div>
                                </div>
                            </div>
                            <div class="col-md-6 mb-2">
                                <div class="dropdown">
                                    <button class="btn btn-outline-secondary dropdown-toggle w-100 text-left d-flex justify-content-between align-items-center" type="button" id="yearDropdown" data-toggle="dropdown">
                                        <span><i class="fas fa-calendar mr-2"></i>Selecciona Año</span>
                                    </button>
                                    <div class="dropdown-menu w-100" id="yearDropdownMenu"></div>
                                </div>
                            </div>
                        </div>

                        <!-- Tabla Principal -->
                        <div class="table-responsive">
                            <table class="table table-sm table-bordered table-hover" id="modelosTable">
                                <thead class="thead-light">
                                    <tr id="modelosTableHeader"></tr>
                                </thead>
                                <tbody id="modelosTableBody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // -------------------------------------------------------------------------
        // DATOS PARA PESTAÑA 1 (Ventas de Coches)
        // -------------------------------------------------------------------------
        // Objeto con marcas reales y 7 modelos correspondientes para cada una
        var carBrands = {
          "Toyota": ["Corolla", "Camry", "RAV4", "Prius", "Highlander", "Land Cruiser", "Yaris"],
          "Ford": ["Fiesta", "Focus", "Mustang", "Explorer", "Edge", "Fusion", "EcoSport"],
          "Honda": ["Civic", "Accord", "CR-V", "Pilot", "Fit", "Odyssey", "HR-V"],
          "Chevrolet": ["Spark", "Malibu", "Impala", "Tahoe", "Cruze", "Equinox", "Traverse"],
          "BMW": ["Serie 3", "Serie 5", "X3", "X5", "Serie 7", "X1", "X6"],
          "Mercedes-Benz": ["Clase A", "Clase C", "Clase E", "Clase S", "GLA", "GLC", "GLE"]
        };

        // Lista predefinida de nombres de sucursales
        var branchNames = ["Sucursal Centro", "Sucursal Norte", "Sucursal Sur", "Sucursal Este", "Sucursal Oeste"];

        // -------------------------------------------------------------------------
        // DATOS PARA PESTAÑA 2 (Modelos y Versiones)
        // -------------------------------------------------------------------------
        // Modelos disponibles (ejemplo) y sus posibles versiones
        var carModels = {
          "March": ["Version 1", "Version 2", "Version 3"],
          "Sentra": ["Version 1", "Version 2", "Version 3"],
          "Versa": ["Version 1", "Version 2"],
          "Altima": ["Version 1", "Version 2", "Version 3", "Version 4"]
        };
        // Años disponibles para esos modelos
        var modelYears = ["2023", "2024", "2025"];

        // -------------------------------------------------------------------------
        // FUNCIONES AUXILIARES
        // -------------------------------------------------------------------------
        // Función para obtener un número aleatorio entre min y max (inclusive)
        function getRandomInt(min, max) {
          return Math.floor(Math.random() * (max - min + 1)) + min;
        }

        // Función para barajar un array (algoritmo Fisher-Yates)
        function shuffleArray(array) {
          var currentIndex = array.length, temporaryValue, randomIndex;
          while (0 !== currentIndex) {
            randomIndex = Math.floor(Math.random() * currentIndex);
            currentIndex -= 1;
            temporaryValue = array[currentIndex];
            array[currentIndex] = array[randomIndex];
            array[randomIndex] = temporaryValue;
          }
          return array;
        }

        // -------------------------------------------------------------------------
        // PESTAÑA 1: Lógica de Ventas de Coches
        // -------------------------------------------------------------------------
        function populateMarcaDropdown() {
          var $marcaDropdownMenu = $("#marcaDropdownMenu");
          $marcaDropdownMenu.empty();
          for (var marca in carBrands) {
            $marcaDropdownMenu.append(
              '<a class="dropdown-item" href="#" data-value="' + marca + '">' + marca + "</a>"
            );
          }
        }

        function populateSucursalDropdown() {
          var shuffledBranches = shuffleArray(branchNames.slice());
          var $sucursalDropdownMenu = $("#sucursalDropdownMenu");
          $sucursalDropdownMenu.empty();
          // Se agregan entre 3 y 5 sucursales (aleatoriamente)
          var count = getRandomInt(3, Math.min(5, shuffledBranches.length));
          for (var i = 0; i < count; i++) {
            var branch = shuffledBranches[i];
            $sucursalDropdownMenu.append(
              '<a class="dropdown-item" href="#" data-value="' + branch + '">' + branch + "</a>"
            );
          }
        }

        function updateTable() {
          // Marca seleccionada
          var selectedBrand = $("#marcaDropdown").data("selected");
          if (!selectedBrand) {
            // Si no se ha seleccionado nada, tomamos la primera marca
            selectedBrand = Object.keys(carBrands)[0];
            $("#marcaDropdown").find('span').html(`<i class="fas fa-tag mr-2"></i>${selectedBrand}`).data("selected", selectedBrand);
          }
          var models = carBrands[selectedBrand];

          // 1) Construir encabezado (incluyendo la nueva columna "Total Vendido")
          var headerHtml = "<th class='text-left'>Vendedor</th>";
          models.forEach(function(model) {
            headerHtml += "<th class='text-center'>" + model + "</th>";
          });
          // Columna extra al final
          headerHtml += "<th class='text-center'>Total Vendido</th>";
          $("#tableHeader").html(headerHtml);

          // 2) Generar filas con datos aleatorios
          var bodyHtml = "";

          // Para acumular las sumas de cada columna (tantas como modelos)
          var colSums = new Array(models.length).fill(0);
          // Para acumular la suma global
          var grandTotal = 0;

          // Generamos 8 filas (8 vendedores)
          for (var i = 1; i <= 8; i++) {
            var rowData = models.map(function() {
              return getRandomInt(0, 20);
            });

            var rowSum = rowData.reduce(function(a, b) { return a + b; }, 0);
            // Actualizar sumas por columna
            for (var j = 0; j < models.length; j++) {
              colSums[j] += rowData[j];
            }
            // Sumar al gran total
            grandTotal += rowSum;

            bodyHtml += "<tr>";
            bodyHtml += "<td class='text-left'>Vendedor " + i + "</td>";
            rowData.forEach(function(value) {
              bodyHtml += "<td class='text-center'>" + value + "</td>";
            });
            bodyHtml += '<td class="text-center"><strong>' + rowSum + "</strong></td>";
            bodyHtml += "</tr>";
          }

          // Fila de Totales (con clase table-info)
          bodyHtml += '<tr class="table-info">';
          bodyHtml += "<td class='text-left'><strong>Total</strong></td>";
          colSums.forEach(function(colSum) {
            bodyHtml += "<td class='text-center'><strong>" + colSum + "</strong></td>";
          });
          bodyHtml += "<td class='text-center'><strong>" + grandTotal + "</strong></td>";
          bodyHtml += "</tr>";

          // Fila de Porcentajes (con clase table-light)
          bodyHtml += '<tr class="table-light">';
          bodyHtml += "<td class='text-left'><strong>% del Total</strong></td>";
          colSums.forEach(function(colSum) {
            var pct = (grandTotal > 0) ? ((colSum / grandTotal) * 100).toFixed(2) : 0;
            bodyHtml += "<td class='text-center'><strong>" + pct + "%</strong></td>";
          });
          // Última columna: siempre 100%
          bodyHtml += "<td class='text-center'><strong>100%</strong></td>";
          bodyHtml += "</tr>";

          $("#tableBody").html(bodyHtml);
        }

        // -------------------------------------------------------------------------
        // PESTAÑA 2: Lógica de Modelos y Versiones
        // -------------------------------------------------------------------------
        function populateModeloDropdown() {
          var $modeloDropdownMenu = $("#modeloDropdownMenu");
          $modeloDropdownMenu.empty();
          for (var modelo in carModels) {
            $modeloDropdownMenu.append(
              '<a class="dropdown-item" href="#" data-value="' + modelo + '">' + modelo + "</a>"
            );
          }
        }

        function populateYearDropdown() {
          var $yearDropdownMenu = $("#yearDropdownMenu");
          $yearDropdownMenu.empty();
          modelYears.forEach(function(year) {
            $yearDropdownMenu.append(
              '<a class="dropdown-item" href="#" data-value="' + year + '">' + year + "</a>"
            );
          });
        }

        function updateModelVersionTable() {
          // Modelo seleccionado
          var selectedModel = $("#modeloDropdown").data("selected");
          if (!selectedModel) {
            // Si no se ha seleccionado, tomamos el primero
            selectedModel = Object.keys(carModels)[0];
            $("#modeloDropdown").find('span').html(`<i class="fas fa-car mr-2"></i>${selectedModel}`).data("selected", selectedModel);
          }

          // Año seleccionado
          var selectedYear = $("#yearDropdown").data("selected");
          if (!selectedYear) {
            // Si no se ha seleccionado, tomamos el primero
            selectedYear = modelYears[0];
            $("#yearDropdown").find('span').html(`<i class="fas fa-calendar mr-2"></i>${selectedYear}`).data("selected", selectedYear);
          }

          // Columnas basadas en tu imagen de ejemplo
          var columns = [
            "Pedidos sin afectar SN/FTC",
            "Pedidos sin afectar CI/FTC",
            "Pedidos estatus Pendiente",
            "Pedidos Anticipo",
            "Pedido Búsqueda",
            "VIN Reservado",
            "Total de Pedidos",
            "Inventario Disponible"
          ];

          // Construir encabezado
          var headerHtml = "<th class='text-left'>Versión</th>";
          columns.forEach(function(col) {
            headerHtml += "<th class='text-center'>" + col + "</th>";
          });
          $("#modelosTableHeader").html(headerHtml);

          // Obtenemos las versiones disponibles para ese modelo
          var versions = carModels[selectedModel];

          // Variables para sumas de columnas
          var colSums = new Array(columns.length).fill(0);
          var bodyHtml = "";
          var grandTotalPedidos = 0;

          // Generar filas para cada versión
          versions.forEach(function(version) {
            // Generamos datos aleatorios para las primeras 6 columnas
            var rowData = [];
            for (var i = 0; i < 6; i++) {
              rowData.push(getRandomInt(0, 10));
            }

            // Sumar esos 6 campos para la col "Total de Pedidos"
            var totalPedidos = rowData.reduce(function(a, b) { return a + b; }, 0);

            // Generar un valor aleatorio para "Inventario Disponible"
            var inventario = getRandomInt(0, 20);

            // Construimos la fila
            bodyHtml += "<tr>";
            // Primera celda: "Versión"
            bodyHtml += "<td class='text-left'>" + version + "</td>";

            // Agregamos las 6 columnas
            for (var j = 0; j < 6; j++) {
              bodyHtml += "<td class='text-center'>" + rowData[j] + "</td>";
            }

            // Col "Total de Pedidos"
            bodyHtml += "<td class='text-center'><strong>" + totalPedidos + "</strong></td>";

            // Col "Inventario Disponible"
            bodyHtml += "<td class='text-center'>" + inventario + "</td>";

            bodyHtml += "</tr>";

            // Actualizamos sumas de columnas
            for (var c = 0; c < 6; c++) {
              colSums[c] += rowData[c];
            }
            colSums[6] += totalPedidos;
            colSums[7] += inventario;
          });

          // Fila de totales (con clase table-info)
          bodyHtml += '<tr class="table-info">';
          bodyHtml += "<td class='text-left'><strong>Total</strong></td>";
          for (var cIndex = 0; cIndex < columns.length; cIndex++) {
            bodyHtml += "<td class='text-center'><strong>" + colSums[cIndex] + "</strong></td>";
          }
          bodyHtml += "</tr>";

          // Fila de porcentajes (con clase table-light)
          var totalPedidosGlobal = colSums[6];
          bodyHtml += '<tr class="table-light">';
          bodyHtml += "<td class='text-left'><strong>% del Total</strong></td>";

          for (var cIndex2 = 0; cIndex2 < columns.length; cIndex2++) {
            if (cIndex2 < 7) {
              var pct = (totalPedidosGlobal > 0)
                ? ((colSums[cIndex2] / totalPedidosGlobal) * 100).toFixed(2)
                : 0;
              bodyHtml += "<td class='text-center'><strong>" + pct + "%</strong></td>";
            } else {
              bodyHtml += "<td class='text-center'><strong>--</strong></td>";
            }
          }
          bodyHtml += "</tr>";

          $("#modelosTableBody").html(bodyHtml);
        }

        // -------------------------------------------------------------------------
        // DOCUMENT READY
        // -------------------------------------------------------------------------
        $(document).ready(function() {
          // Fecha actual por defecto para la primera pestaña
          $("#fechaFiltro").val(new Date().toISOString().split("T")[0]);

          // PESTAÑA 1: Ventas de Coches
          populateMarcaDropdown();
          populateSucursalDropdown();
          updateTable();

          // Eventos en dropdown de marcas
          $(document).on("click", "#marcaDropdownMenu a", function(e) {
            e.preventDefault();
            var value = $(this).data("value");
            $("#marcaDropdown").find('span').html(`<i class="fas fa-tag mr-2"></i>${value}`).data("selected", value);
            updateTable();
          });

          // Eventos en dropdown de sucursales
          $(document).on("click", "#sucursalDropdownMenu a", function(e) {
            e.preventDefault();
            var value = $(this).data("value");
            $("#sucursalDropdown").find('span').html(`<i class="fas fa-store mr-2"></i>${value}`).data("selected", value);
            updateTable();
          });

          // Cambio de fecha
          $("#fechaFiltro").on("change", function() {
            updateTable();
          });

          // PESTAÑA 2: Modelos y Versiones
          populateModeloDropdown();
          populateYearDropdown();
          updateModelVersionTable();

          // Eventos en dropdown de modelo
          $(document).on("click", "#modeloDropdownMenu a", function(e) {
            e.preventDefault();
            var value = $(this).data("value");
            $("#modeloDropdown").find('span').html(`<i class="fas fa-car mr-2"></i>${value}`).data("selected", value);
            updateModelVersionTable();
          });

          // Eventos en dropdown de año
          $(document).on("click", "#yearDropdownMenu a", function(e) {
            e.preventDefault();
            var value = $(this).data("value");
            $("#yearDropdown").find('span').html(`<i class="fas fa-calendar mr-2"></i>${value}`).data("selected", value);
            updateModelVersionTable();
          });
        });
    </script>
</body>

</html>